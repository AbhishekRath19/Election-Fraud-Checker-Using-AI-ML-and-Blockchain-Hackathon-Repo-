{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Blockchain Dashboard</h2>
    
    <div class="dashboard-section">
        <h3>Blockchain Status</h3>
        {% if status.connected %}
            <div class="status-card success">
                <h4>Connected to Blockchain</h4>
                <p>Local votes: {{ status.local_votes }}</p>
                <p>Blockchain votes: {{ status.blockchain_votes }}</p>
                <p>Pending synchronization: {{ status.pending_sync }}</p>
                {% if status.test_count is not none %}
                    <p>Test count: {{ status.test_count }}</p>
                {% endif %}
            </div>
        {% else %}
            <div class="status-card error">
                <h4>Not Connected to Blockchain</h4>
                {% if status.error %}
                    <p>Error: {{ status.error }}</p>
                {% endif %}
                <p>Please check your blockchain configuration.</p>
            </div>
        {% endif %}
    </div>
    
    <div class="dashboard-section">
        <h3>Actions</h3>
        <div class="actions">
            <button id="syncBtn" class="button">Synchronize with Blockchain</button>
            <button id="verifyBtn" class="button">Verify Consistency</button>
        </div>
        <div id="actionResult"></div>
    </div>
    
    <div class="dashboard-section">
        <h3>Recent Votes</h3>
        {% if recent_votes %}
            <div class="recent-votes">
                <table>
                    <thead>
                        <tr>
                            <th>Vote ID</th>
                            <th>User ID</th>
                            <th>Party ID</th>
                            <th>Voted At</th>
                            <th>Blockchain Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vote in recent_votes %}
                            <tr>
                                <td>{{ vote.id }}</td>
                                <td>{{ vote.user_id }}</td>
                                <td>{{ vote.party_id }}</td>
                                <td>{{ vote.voted_at }}</td>
                                <td>
                                    {% if vote.blockchain_tx_hash %}
                                        <span class="status success">Synced</span>
                                    {% else %}
                                        <span class="status warning">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No votes recorded yet.</p>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const syncBtn = document.getElementById('syncBtn');
    const verifyBtn = document.getElementById('verifyBtn');
    const actionResult = document.getElementById('actionResult');
    
    if (syncBtn) {
        syncBtn.addEventListener('click', function() {
            performAction('/blockchain/sync', 'Synchronization');
        });
    }
    
    if (verifyBtn) {
        verifyBtn.addEventListener('click', function() {
            performAction('/blockchain/verify', 'Verification');
        });
    }
    
    function performAction(url, actionName) {
        actionResult.innerHTML = '<p>Performing ' + actionName.toLowerCase() + '...</p>';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actionResult.innerHTML = '<div class="flash-message success">' + data.message + '</div>';
                } else {
                    actionResult.innerHTML = '<div class="flash-message error">' + data.message + '</div>';
                }
                
                // Reload page after 3 seconds to show updated status
                setTimeout(() => {
                    location.reload();
                }, 3000);
            })
            .catch(error => {
                actionResult.innerHTML = '<div class="flash-message error">Error: ' + error.message + '</div>';
            });
    }
});
</script>

<style>
.dashboard-section {
    margin-bottom: 30px;
    padding: 20px;
    background-color: white;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.status-card {
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.status-card.success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}

.status-card.error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}

.status-card h4 {
    margin-top: 0;
}

.actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.actions .button {
    margin-right: 10px;
}

.recent-votes table {
    width: 100%;
    border-collapse: collapse;
}

.recent-votes th,
.recent-votes td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.recent-votes th {
    background-color: #f8f9fa;
}

.status {
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
}

.status.success {
    background-color: #28a745;
    color: white;
}

.status.warning {
    background-color: #ffc107;
    color: #212529;
}
</style>
{% endblock %}